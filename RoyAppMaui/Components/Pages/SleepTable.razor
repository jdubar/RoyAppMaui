@page "/sleeptable"

@using RoyAppMaui.Models

<MudDataGrid T="Sleep"
             Items="@SleepItems"
             Bordered="true" Dense="true"
             EditMode="DataGridEditMode.Cell"
             EditTrigger="@(_editTriggerRowClick ? DataGridEditTrigger.OnRowClick : DataGridEditTrigger.Manual)"
             Elevation="25">
    <Columns>
        <PropertyColumn Property="x => x.Id" />
        <PropertyColumn Property="x => x.Bedtime">
            <EditTemplate>
                <MudTimePicker Label="Bedtime" AmPm="true" @bind-BedTime="context.Item.Bedtime" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.BedtimeRec" Title="Bedtime (As Decimal)" IsEditable="false" />
        <PropertyColumn Property="x => x.Waketime">
            <EditTemplate>
                <MudTimePicker Label="Waketime" AmPm="true" @bind-BedTime="context.Item.Waketime" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.WaketimeRec" Title="Waketime (As Decimal)" IsEditable="false" />
        <PropertyColumn Property="x => x.Duration" IsEditable="false" />
    </Columns>
</MudDataGrid>
<br />
<MudCard Elevation="25">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Add / Edit Sleep</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudNumericField @bind-Value="sleep.Id"
                         Label="Id"
                         Variant="Variant.Text"
                         Margin="Margin.Normal" />
        <MudTimePicker @bind-Time="sleep.Bedtime"
                       @ref="_bedtimepicker"
                       AmPm="true"
                       Editable="true"
                       ImmediateText="true"
                       Label="Bedtime"
                       HelperText="Enter any numeric value as hours:minutes"
                       PickerVariant="PickerVariant.Dialog"
                       Elevation="12"
                       Placeholder="hh:mm"
                       TimeFormat="HH:mm"
                       Variant="Variant.Text"
                       Margin="Margin.Normal"
                       PickerClosed="ResetBedTimeValidation" />
        <MudTimePicker @bind-Time="sleep.Waketime"
                       @ref="_waketimepicker"
                       AmPm="true"
                       Editable="true"
                       ImmediateText="true"
                       Label="Waketime"
                       HelperText="Enter any numeric value as hours:minutes"
                       PickerVariant="PickerVariant.Dialog"
                       Elevation="12"
                       Placeholder="hh:mm"
                       TimeFormat="HH:mm"
                       Variant="Variant.Text"
                       Margin="Margin.Normal"
                       PickerClosed="ResetWakeTimeValidation" />
        <br />
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="Save">Save</MudButton>
    </MudCardContent>
</MudCard>

@code {
    private List<Sleep> SleepItems = new List<Sleep>();
    private bool _editTriggerRowClick;
    private Sleep sleep = new Sleep();
    private MudTimePicker? _bedtimepicker;
    private MudTimePicker? _waketimepicker;

    private void Save()
    {
        // TODO: Fix adding new item changes all items
        SleepItems.Add(sleep);
    }

    private void ResetBedTimeValidation() =>
        _bedtimepicker?.ResetValidation();

    private void ResetWakeTimeValidation() =>
        _waketimepicker?.ResetValidation();
}